<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <title>Virtual Authenticator</title>
  <style>
    #container {
      min-height: calc(100vh - 125px);
    }

    .footer {
      text-align: center;
      height: 100px;
    }

    .footer-container {
      padding-right: 15px;
      padding-left: 15px;
      margin-right: auto;
      margin-left: auto;
    }
    body { font-family: sans-serif; margin: 24px; }
    button { margin-right: 12px; padding: 8px 16px; }
    #log { margin-top: 16px; white-space: pre-line; }
  </style>
</head>
<body>
<div id="container">
  <h2>虚拟验签演示</h2>
  <button id="register">注册凭证</button>
  <button id="authenticate" disabled>发起认证</button>
  <div id="log"></div>
</div>

<script>
  let lastCredentialId;

  const pad = (str) => str.replace(/-/g, '+').replace(/_/g, '/');
  const b64ToBytes = (b64) => Uint8Array.from(atob(pad(b64)), c => c.charCodeAt(0));
  const bytesToB64 = (bytes) =>
          btoa(String.fromCharCode(...new Uint8Array(bytes))).replace(/\+/g, '-').replace(/\//g, '_').replace(/=/g, '');

  const log = (msg) => (document.getElementById('log').textContent += `${msg}\n`);

  document.getElementById('register').onclick = async () => {
    try {
      const publicKey = {
        challenge: crypto.getRandomValues(new Uint8Array(32)),
        rp: { name: 'Virtual RP', id: location.hostname },
        user: {
          id: crypto.getRandomValues(new Uint8Array(16)),
          name: 'demo-user',
          displayName: 'Demo User'
        },
        pubKeyCredParams: [{ type: 'public-key', alg: -7 }],
        authenticatorSelection: {
          residentKey: 'preferred',
          userVerification: 'preferred',
          authenticatorAttachment: 'cross-platform'
        },
        timeout: 60000,
        attestation: 'none'
      };

      const credential = await navigator.credentials.create({ publicKey });
      lastCredentialId = new Uint8Array(credential.rawId);
      document.getElementById('authenticate').disabled = false;
      log(`注册成功\ncredId=${bytesToB64(lastCredentialId)}`);
    } catch (e) {
      log(`注册失败: ${e.message}`);
    }
  };

  document.getElementById('authenticate').onclick = async () => {
    if (!lastCredentialId) {
      log('请先注册凭证');
      return;
    }
    try {
      const assertion = await navigator.credentials.get({
        publicKey: {
          challenge: crypto.getRandomValues(new Uint8Array(32)),
          timeout: 60000,
          userVerification: 'preferred',
          allowCredentials: [{
            type: 'public-key',
            id: lastCredentialId.buffer
          }]
        }
      });
      log(`认证成功\ncredId=${bytesToB64(assertion.rawId)}`);
    } catch (e) {
      log(`认证失败: ${e.message}`);
    }
  };
</script>
<footer class="footer">
  <hr>
  <div class="footer-container">
    <p><a href="https://github.com/alaahong/" target="_blank">Github</a>
      | <a href="https://www.linkedin.com/in/alaahong/" target="_blank">LinkedIn</a>
      | <a href="mailto:hi@ianzhang.cn">Mail</a>
    </p>
    <p>© 2021<span id="footer-year"></span> <a href="https://www.ianzhang.cn" target="_blank">IanZhang</a>
    </p>
  </div>
</footer>
</body>
</html>